# 直接检测架构说明

## 设计理念

**核心思想**: CAM热图 + 图像特征 → 直接预测框，无需阈值检测

### 当前方法（有问题）❌
```
CAM → [阈值检测峰值] → 匹配 → 提取框
       ↑
    固定阈值，不可训练
```

### 新方法（直接检测）✅
```
CAM + 图像特征 → [检测网络] → 直接预测框和置信度
                  ↑
              端到端训练
```

---

## 架构设计

### 1. DirectDetectionHead

**输入**:
- CAM热图: `[B, C, H, W]`
- 图像特征: `[B, N², D]` (patch features from SurgeryCLIP)

**处理流程**:
1. 投影图像特征到hidden_dim
2. 上采样到CAM分辨率
3. 融合CAM和图像特征
4. CNN特征提取
5. 直接预测框和置信度

**输出**:
- 框坐标: `[B, C, H, W, 4]` (xmin, ymin, xmax, ymax)
- 置信度: `[B, C, H, W]` (融合预测置信度和CAM)

### 2. DirectDetectionLoss

**损失项**:
1. **框回归损失**: L1 + GIoU（基于IoU分配正样本）
2. **置信度损失**: Focal Loss（处理类别不平衡）
3. **CAM监督损失**: 鼓励框内高响应、框外低响应

**正样本分配**:
- 基于预测框与GT框的IoU
- 每个GT框匹配IoU最高的位置
- 标记该位置周围区域为正样本（pos_radius）

---

## 优势

1. **端到端训练**: 无需阈值，所有参数可训练
2. **利用图像特征**: 结合原图信息，提高检测精度
3. **直接预测**: 无需峰值检测和匹配步骤
4. **更灵活**: 网络自动学习如何从CAM+特征预测框

---

## 使用方法

```bash
python train_direct_detection.py --config configs/direct_detection_config.yaml
```

---

## 与阈值方法对比

| 特性 | 阈值方法 | 直接检测方法 |
|------|---------|-------------|
| 是否需要阈值 | ✅ 是 | ❌ 否 |
| 是否需要峰值检测 | ✅ 是 | ❌ 否 |
| 是否使用图像特征 | ❌ 否 | ✅ 是 |
| 端到端训练 | ❌ 否 | ✅ 是 |
| 灵活性 | 低 | 高 |

---

## 预期效果

1. **更好的检测精度**: 利用图像特征
2. **更稳定的训练**: 无需阈值调优
3. **端到端优化**: 所有组件联合训练
4. **更少的超参数**: 不需要阈值参数


