# Experiment1 åæ ‡æ ¼å¼ç»Ÿä¸€è¯´æ˜Ž

## ðŸ“ åæ ‡æ ¼å¼æ ‡å‡†

### 1. è¾¹ç•Œæ¡†æ ¼å¼å®šä¹‰

**XYXYæ ¼å¼** (å·¦ä¸Šè§’ + å³ä¸‹è§’):
```python
box = [x1, y1, x2, y2]
# x1, y1: å·¦ä¸Šè§’åæ ‡
# x2, y2: å³ä¸‹è§’åæ ‡
# çº¦æŸ: x2 > x1, y2 > y1
```

**XYWHæ ¼å¼** (å·¦ä¸Šè§’ + å®½é«˜):
```python
box = [x, y, w, h]
# x, y: å·¦ä¸Šè§’åæ ‡
# w: å®½åº¦
# h: é«˜åº¦
```

**CXCYWHæ ¼å¼** (ä¸­å¿ƒç‚¹ + å®½é«˜):
```python
box = [cx, cy, w, h]
# cx, cy: ä¸­å¿ƒç‚¹åæ ‡
# w: å®½åº¦
# h: é«˜åº¦
```

### 2. åæ ‡ç³»ç»Ÿ

**åƒç´ åæ ‡** (Pixel Coordinates):
```python
# èŒƒå›´: [0, image_width] Ã— [0, image_height]
# å•ä½: åƒç´ 
# ç”¨äºŽ: å¯è§†åŒ–ã€IoUè®¡ç®—
```

**å½’ä¸€åŒ–åæ ‡** (Normalized Coordinates):
```python
# èŒƒå›´: [0, 1] Ã— [0, 1]
# å•ä½: ç›¸å¯¹æ¯”ä¾‹
# ç”¨äºŽ: æ¨¡åž‹è¾“å‡ºã€æ•°æ®å¢žå¼º
```

---

## ðŸ“‹ Experiment1 ä¸­çš„åæ ‡æ ¼å¼

### Stage1: æè®®ç”Ÿæˆ

**è¾“å…¥**:
- å›¾åƒ: PIL Image æˆ– numpy array
- åæ ‡: åƒç´ åæ ‡

**è¾“å‡º**:
- å€™é€‰æ¡†: `(N, 4)` **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**

```python
# proposal_generator.py
proposals = [
    [x1, y1, x2, y2],  # XYXYåƒç´ åæ ‡
    ...
]
```

### Stage2: ç›®æ ‡æ£€æµ‹

**è¾“å…¥**:
- å€™é€‰æ¡†: **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**
- å›¾åƒ: PIL Image

**è¾“å‡º**:
- æ£€æµ‹æ¡†: **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**
- åˆ†æ•°: float [0, 1]
- ç±»åˆ«: int

```python
# target_detector.py
detections = {
    'boxes': [[x1, y1, x2, y2], ...],  # XYXYåƒç´ åæ ‡
    'scores': [0.95, 0.87, ...],
    'labels': [1, 5, ...]
}
```

### è¾¹ç•Œæ¡†ç»†åŒ–

**è¾“å…¥/è¾“å‡º**:
- **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**

```python
# bbox_refiner.py
refined_box = refine_bbox(
    box,        # [x1, y1, x2, y2] åƒç´ åæ ‡
    image,
    context
)
# è¿”å›ž: [x1, y1, x2, y2] åƒç´ åæ ‡
```

---

## ðŸ”§ åæ ‡è½¬æ¢å‡½æ•°

### XYXY â†” XYWH

```python
def xyxy_to_xywh(box):
    """
    XYXY -> XYWH
    
    å‚æ•°:
        box: [x1, y1, x2, y2]
    è¿”å›ž:
        box: [x, y, w, h]
    """
    x1, y1, x2, y2 = box
    x = x1
    y = y1
    w = x2 - x1
    h = y2 - y1
    return [x, y, w, h]


def xywh_to_xyxy(box):
    """
    XYWH -> XYXY
    
    å‚æ•°:
        box: [x, y, w, h]
    è¿”å›ž:
        box: [x1, y1, x2, y2]
    """
    x, y, w, h = box
    x1 = x
    y1 = y
    x2 = x + w
    y2 = y + h
    return [x1, y1, x2, y2]
```

### XYXY â†” CXCYWH

```python
def xyxy_to_cxcywh(box):
    """
    XYXY -> CXCYWH
    
    å‚æ•°:
        box: [x1, y1, x2, y2]
    è¿”å›ž:
        box: [cx, cy, w, h]
    """
    x1, y1, x2, y2 = box
    cx = (x1 + x2) / 2
    cy = (y1 + y2) / 2
    w = x2 - x1
    h = y2 - y1
    return [cx, cy, w, h]


def cxcywh_to_xyxy(box):
    """
    CXCYWH -> XYXY
    
    å‚æ•°:
        box: [cx, cy, w, h]
    è¿”å›ž:
        box: [x1, y1, x2, y2]
    """
    cx, cy, w, h = box
    x1 = cx - w / 2
    y1 = cy - h / 2
    x2 = cx + w / 2
    y2 = cy + h / 2
    return [x1, y1, x2, y2]
```

### å½’ä¸€åŒ– â†” åƒç´ 

```python
def normalize_boxes(boxes, image_size):
    """
    åƒç´ åæ ‡ -> å½’ä¸€åŒ–åæ ‡
    
    å‚æ•°:
        boxes: (N, 4) åƒç´ åæ ‡
        image_size: (height, width)
    è¿”å›ž:
        boxes: (N, 4) å½’ä¸€åŒ–åæ ‡ [0, 1]
    """
    h, w = image_size
    boxes = boxes.copy()
    boxes[:, [0, 2]] /= w  # xåæ ‡
    boxes[:, [1, 3]] /= h  # yåæ ‡
    return boxes


def denormalize_boxes(boxes, image_size):
    """
    å½’ä¸€åŒ–åæ ‡ -> åƒç´ åæ ‡
    
    å‚æ•°:
        boxes: (N, 4) å½’ä¸€åŒ–åæ ‡
        image_size: (height, width)
    è¿”å›ž:
        boxes: (N, 4) åƒç´ åæ ‡
    """
    h, w = image_size
    boxes = boxes.copy()
    boxes[:, [0, 2]] *= w  # xåæ ‡
    boxes[:, [1, 3]] *= h  # yåæ ‡
    return boxes
```

---

## âœ… ä½¿ç”¨è§„èŒƒ

### 1. å‡½æ•°å‚æ•°æ ‡æ³¨

**å¼ºåˆ¶è¦æ±‚**ï¼šåœ¨æ‰€æœ‰æ¶‰åŠè¾¹ç•Œæ¡†çš„å‡½æ•°ä¸­æ˜Žç¡®æ ‡æ³¨æ ¼å¼

```python
def my_function(boxes):
    """
    å‚æ•°:
        boxes: (N, 4) [x1, y1, x2, y2] - XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡
               æˆ– (N, 4) [cx, cy, w, h] - CXCYWHæ ¼å¼ï¼Œå½’ä¸€åŒ–åæ ‡
    """
    pass
```

### 2. å˜é‡å‘½åè§„èŒƒ

```python
# æŽ¨èçš„å˜é‡å‘½åï¼š
boxes_xyxy          # XYXYæ ¼å¼
boxes_xywh          # XYWHæ ¼å¼
boxes_cxcywh        # CXCYWHæ ¼å¼
boxes_norm          # å½’ä¸€åŒ–åæ ‡
boxes_pixel         # åƒç´ åæ ‡
```

### 3. åæ ‡è½¬æ¢æ£€æŸ¥

```python
# è½¬æ¢å‰æ£€æŸ¥
assert (boxes[:, 2] > boxes[:, 0]).all(), "x2 must > x1"
assert (boxes[:, 3] > boxes[:, 1]).all(), "y2 must > y1"

# å½’ä¸€åŒ–æ£€æŸ¥
assert (boxes >= 0).all() and (boxes <= 1).all(), "Must be in [0, 1]"
```

---

## ðŸ” å¸¸è§é—®é¢˜

### Q1: IoUè®¡ç®—ä½¿ç”¨ä»€ä¹ˆæ ¼å¼ï¼Ÿ

**A**: å§‹ç»ˆä½¿ç”¨ **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**

```python
# æ­£ç¡®
iou = compute_iou(box1_xyxy_pixel, box2_xyxy_pixel)

# é”™è¯¯
iou = compute_iou(box1_cxcywh, box2_cxcywh)  # éœ€è¦å…ˆè½¬æ¢
```

### Q2: æ•°æ®å¢žå¼ºæ—¶å¦‚ä½•å¤„ç†åæ ‡ï¼Ÿ

**A**: ä¿æŒæ ¼å¼ä¸å˜ï¼Œç›¸åº”è°ƒæ•´æ•°å€¼

```python
# æ°´å¹³ç¿»è½¬ (XYXYæ ¼å¼)
x1_new = image_width - x2
x2_new = image_width - x1

# ç¼©æ”¾ (ä»»ä½•æ ¼å¼)
boxes *= scale_factor
```

### Q3: å¦‚ä½•åœ¨ä¸åŒæ¨¡å—é—´ä¼ é€’è¾¹ç•Œæ¡†ï¼Ÿ

**A**: ç»Ÿä¸€ä½¿ç”¨ **XYXYæ ¼å¼ï¼Œåƒç´ åæ ‡**ï¼Œåœ¨æ¨¡å—å†…éƒ¨è½¬æ¢

```python
# æ¨¡å—Aè¾“å‡º
output_boxes = boxes_xyxy_pixel

# æ¨¡å—Bè¾“å…¥
def module_B(boxes_xyxy_pixel):
    # å†…éƒ¨è½¬æ¢ä¸ºéœ€è¦çš„æ ¼å¼
    boxes_cxcywh = xyxy_to_cxcywh(boxes_xyxy_pixel)
    ...
```

---

## ðŸ“ æ£€æŸ¥æ¸…å•

å¼€å‘æ—¶æ£€æŸ¥ï¼š
- [ ] å‡½æ•°å‚æ•°æ˜¯å¦æ ‡æ³¨äº†åæ ‡æ ¼å¼ï¼Ÿ
- [ ] å˜é‡å‘½åæ˜¯å¦æ¸…æ™°è¡¨æ˜Žæ ¼å¼ï¼Ÿ
- [ ] IoUè®¡ç®—æ˜¯å¦ä½¿ç”¨XYXYæ ¼å¼ï¼Ÿ
- [ ] åæ ‡è½¬æ¢æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] å½’ä¸€åŒ–/åå½’ä¸€åŒ–æ˜¯å¦æ­£ç¡®å¤„ç†äº†å®½é«˜ï¼Ÿ

---

**åˆ›å»ºæ—¶é—´**: 2025-10-24  
**é€‚ç”¨èŒƒå›´**: Experiment1 æ‰€æœ‰æ¨¡å—  
**æ ‡å‡†**: ç»Ÿä¸€ä½¿ç”¨XYXYæ ¼å¼åƒç´ åæ ‡ä½œä¸ºä¸»è¦æ ¼å¼


