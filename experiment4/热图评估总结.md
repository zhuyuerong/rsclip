# CLIP Surgery 热图评估总结

## 实现完成

已完成CLIP Surgery论文的热图生成和mAP计算完整实现：

### 1. 核心模块

#### VV注意力机制 (`vv_attention.py`)
- 双路径设计：QK路径（原始）+ VV路径
- CLS token使用QK路径，patches使用VV路径
- 支持返回三种注意力权重：`attn_qk`, `attn_vv`, `attn_mixed`
- 自动处理dtype匹配（float32 vs float16）

#### CLIP Surgery VV (`clip_surgery_vv.py`)
- 支持提取最后一层注意力权重
- `encode_image_with_attn()` 方法返回特征和注意力
- 自动替换最后N层为VV注意力

#### 热图生成器 (`utils/heatmap_generator.py`)
- `generate_similarity_heatmap()`: 计算图像-文本相似度热图
- `generate_bboxes_from_heatmap()`: 从热图提取检测框（阈值分割+连通域分析）
- `compute_bbox_score()`: 计算检测框的置信度分数

#### mAP计算器 (`utils/map_calculator.py`)
- `calculate_iou()`: IoU计算
- `calculate_ap()`: 单类别AP计算（11点插值法）
- `calculate_map()`: 所有类别mAP计算

#### 可视化工具 (`utils/visualization.py`)
- 三列可视化：原图+GT框、热图叠加、检测框对比
- 支持保存为PNG文件

### 2. 评估流程 (`run_heatmap_evaluation.py`)

完整流程：
1. 加载数据集（mini_dataset或DIOR）
2. 评估标准CLIP Surgery（生成1种热图）
3. 评估VV机制（生成3种热图：QK、VV、混合）
4. 计算mAP@0.5
5. 保存可视化结果和数值报告

### 3. 当前状态

#### 已完成
- ✅ 所有核心模块实现
- ✅ 热图生成逻辑
- ✅ 检测框提取（阈值分割）
- ✅ mAP计算（PASCAL VOC标准）
- ✅ 可视化工具
- ✅ 完整评估脚本

#### 遇到的问题
- dtype不匹配（float32 vs float16）
  - 已修复：在QKV投影前转换输入dtype
  - 待修复：VV注意力模块权重需要转为half precision

### 4. 实验结果（mini_dataset）

使用mini_dataset验证集（10个样本，6个类别）：

- **标准Surgery**: mAP@0.5 = 0.0000
  - 原因：检测框质量较低，与GT框IoU < 0.5
  
- **VV机制**:（运行中）
  - QK路径热图
  - VV路径热图
  - 混合路径热图

### 5. 输出文件结构

```
experiment4/outputs/heatmap_evaluation/
├── map_results.json           # mAP数值结果
├── evaluation_report.md       # Markdown格式报告
├── standard/                  # 标准Surgery可视化
│   ├── sample_000.png
│   └── ...
├── vv_qk/                     # VV机制QK路径
├── vv_vv/                     # VV机制VV路径
└── vv_mixed/                  # VV机制混合路径
```

### 6. 关键参数

- IoU阈值: 0.5
- 热图阈值百分位: 90 (top 10%)
- VV机制层数: 6层
- 图像尺寸: 224×224
- 热图尺寸: 7×7 (ViT-B/32 patches)

### 7. 下一步

1. 修复VV注意力dtype问题（将权重转为half precision）
2. 完成完整评估流程
3. 在完整DIOR数据集上运行评估
4. 分析不同热图的性能差异
5. 优化检测框生成方法（可选）

## 技术要点

### 热图生成原理

根据CLIP Surgery论文：
1. 提取最后一层Transformer的输出特征
2. 去掉CLS token，只保留patch特征 `[B, 49, 512]`
3. 计算patch特征与文本特征的余弦相似度
4. Reshape到空间维度形成热图 `[B, 7, 7, K]`
5. 上采样到原图尺寸224×224

### 检测框提取方法

1. 阈值分割：保留top 10%激活区域
2. 形态学操作：去除噪声（开运算+闭运算）
3. 连通域分析：提取独立区域
4. 边界框提取：计算每个区域的最小外接矩形
5. 过滤：去除过小的框（< 5×5像素）

### mAP计算方法

采用PASCAL VOC 11点插值法：
1. 按置信度排序所有预测框
2. 计算每个阈值下的precision和recall
3. 在11个recall点（0, 0.1, ..., 1.0）插值precision
4. 平均11个点的precision得到AP
5. 所有类别AP的平均值为mAP

