# 诊断实验结果总结（实验4.1, 4.2, 1.3）

## 🔍 实验目的

验证热图颜色反转的根本原因

## 📊 实验结果

### 实验4.1：Patch相似度Grid诊断

**方法**：打印7×7 patch grid的相似度值，标记GT区域

**结果**：
- **GT区域更高**: 2/5样本（40%）
- **背景更高**: 3/5样本（60%）
- **平均差异**：GT - 背景 = -0.0263

**典型案例**：

| 样本 | GT平均 | 背景平均 | 差异 | 结论 |
|------|--------|----------|------|------|
| trainstation#1 | 0.1354 | 0.2052 | -0.0698 (-34%) | ❌ 异常 |
| storagetank#1 | 0.2129 | 0.2114 | +0.0015 (+0.7%) | ✅ 正常 |
| stadium | 0.1978 | 0.1953 | +0.0024 (+1.2%) | ✅ 正常 |
| trainstation#2 | 0.1660 | 0.1875 | -0.0215 (-11%) | ❌ 异常 |
| storagetank#2 | 0.1604 | 0.2047 | -0.0443 (-22%) | ❌ 异常 |

**关键发现**：
- ❌ **60%样本的GT区域相似度低于背景**
- 这解释了为什么热图颜色反转
- GT区域在75%分位以下，被排除在"高激活"区域外

### 实验4.2：Surgery前后对比

**方法**：对比原始CLIP特征和Surgery去冗余后的相似度

**结果**：

| 样本 | Surgery前(GT-BG) | Surgery后(GT-BG) | 变化 | 是否反转 |
|------|------------------|------------------|------|---------|
| trainstation#1 | -0.0698 | -0.1042 | -0.0344 | ❌ 增强负gap |
| storagetank#1 | +0.0015 | -0.0205 | -0.0220 | ✅ **反转！** |
| stadium | +0.0024 | -0.0366 | -0.0391 | ✅ **反转！** |
| trainstation#2 | -0.0215 | -0.0463 | -0.0248 | ❌ 增强负gap |
| storagetank#2 | -0.0443 | -0.0665 | -0.0222 | ❌ 增强负gap |

**平均变化**：
- Surgery前：GT - 背景 = -0.0263
- Surgery后：GT - 背景 = -0.0548
- **Surgery使gap恶化了108%**（-0.0263 → -0.0548）

**关键发现**：
- ✅ **2/5样本Surgery反转了GT-背景关系**（从正变负）
- ❌ **Surgery整体上扩大了负gap**（从-0.0263到-0.0548）
- Surgery去冗余（F - mean(F)）确实在破坏目标特征

### 实验1.3：反转热图测试

**方法**：使用`-similarity`替代`similarity`生成热图

**生成文件**：
```
experiment4/experiments/exp1_threshold_fix/outputs/
├── comparison_000_trainstation.png
├── comparison_001_storagetank.png
└── comparison_002_stadium.png
```

每张图包含3列：
1. 原图 + GT框
2. 正常热图（Surgery，目标=蓝色）
3. 反转热图（-similarity，目标=红色？）

**结论**：请查看可视化图片验证。如果反转后目标变红色，则确认Surgery是问题根源。

## 💡 核心结论

### 结论1：热图颜色反转的原因

**直接原因**：
- 60%样本的GT区域相似度 < 背景相似度
- GT值低于75%分位，被归一化后的阈值排除

**根本原因**：
- Surgery去冗余（F - mean(F)）抑制了目标的"公共特征"
- 如果目标特征恰好是patches的"平均特征"，就会被削弱
- 背景的"独特性"反而被突出

### 结论2：Surgery去冗余的副作用

Surgery使GT-背景gap从-0.0263恶化到-0.0548（**恶化108%**）：

| 指标 | Surgery前 | Surgery后 | 变化 |
|------|-----------|-----------|------|
| GT平均相似度 | 0.1737 | -0.0280 | -202 ± 21% |
| 背景平均相似度 | 0.2000 | 0.0268 | -97 ± 5% |
| GT-背景gap | -0.0263 | -0.0548 | **恶化108%** |

**解释**：
- Surgery去冗余对背景的影响：-97%（接近归零）
- Surgery去冗余对GT的影响：-202%（**反转为负值**）
- **GT受影响更大，因为目标特征更"公共"**

### 结论3：修复方案优先级

基于诊断结果，修复方案的优先级：

| 优先级 | 方案 | 预期效果 | 实施难度 |
|--------|------|----------|----------|
| **1** | 使用反转热图（-similarity） | GT变红色，立即修复 | 极低 |
| **2** | 不使用Surgery去冗余（原始CLIP） | GT-背景gap从-0.0263变为+0.0024 | 低 |
| **3** | 修复阈值逻辑（原始值百分位） | 正确保留高相似度区域 | 低 |
| 4 | Top-k绝对选择 | 精确控制激活区域 | 中 |
| 5 | 多层融合 | 可能改善，但不确定 | 中 |

## 🎯 下一步行动

### 立即实施（阶段2）

1. **实验1.1**：修复阈值逻辑（原始值百分位）
2. **实验1.2**：实现top-k选择
3. **实验2.1**：使用原始CLIP特征（无Surgery）

预期这3个实验都能显著改善热图和mAP。

### 综合评估（阶段5）

运行所有修复方案并对比：
- 当前（Surgery + 归一化阈值）：mAP@0.05=0.28
- 反转热图：mAP@0.05=?
- 无Surgery：mAP@0.05=?
- 修复阈值：mAP@0.05=?

找出最佳组合。

---

**诊断时间**：2025-10-29 14:10

**关键发现**：Surgery去冗余使GT-背景gap恶化108%，是热图颜色反转的根本原因。

