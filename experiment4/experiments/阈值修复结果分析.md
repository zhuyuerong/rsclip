# 阈值修复结果分析

## 实验结果

| 方法 | mAP@0.05 | mAP@0.10 | mAP@0.20 | mAP@0.50 |
|------|----------|----------|----------|----------|
| 原始方法(归一化+百分位) | 0.2780 | 0.1778 | 0.0000 | 0.0000 |
| 修复方法1(原始值百分位) | 0.2851 | 0.1783 | 0.0000 | 0.0000 |
| 修复方法2(Top-25%) | 0.2851 | 0.1783 | 0.0000 | 0.0000 |

**提升**：仅+2.6%（0.0071）

## 为什么改善不明显？

### 原因分析

从实验4.1的数据看到：

| 统计量 | 原始相似度范围 |
|--------|----------------|
| 全图min | 0.12 |
| 全图max | 0.24 |
| 全图范围 | **仅0.12差异** |

**关键发现**：相似度分布极度狭窄！

#### 归一化的影响被高估了

- **归一化前**：0.12-0.24（范围0.12）
- **归一化后**：0.0-1.0（范围1.0）
- 75%阈值：
  - 归一化方法：0.81（归一化值） → 约0.22（原始值）
  - 原始值方法：直接0.22（原始值的75%ile）

**结果**：两个阈值几乎相同！所以mAP改善不明显。

### 真正的问题

1. **相似度动态范围太小**（0.12-0.24）
   - GT区域：0.12-0.18
   - 背景区域：0.16-0.24
   - 重叠严重！

2. **75%阈值对应0.22**
   - 无论是否归一化，都会排除大部分GT区域（0.12-0.18）

3. **Surgery后动态范围更大但包含负值**
   - Surgery前：0.12-0.24
   - Surgery后：-0.11 ~ +0.08
   - GT区域变负（-0.11 ~ -0.08）
   - 但75%阈值仍然约0.01，排除负值的GT

## 真正有效的修复

### 方案1：大幅降低阈值到30-50%

```python
# 当前75%阈值 = 0.22（排除GT）
# 改为50%阈值 = 约0.19（可能包含部分GT）
# 改为30%阈值 = 约0.16（应该包含GT）
```

### 方案2：使用绝对阈值

```python
# 不用百分位，直接设定阈值
threshold = 0.15  # 比GT平均值略低
mask = (heatmap >= threshold)
```

### 方案3：使用反转热图（Surgery场景）

```python
# Surgery使GT变负值，反转后GT变为正的最大值
similarity_inverted = -similarity
# 然后用任何阈值都能正确选中GT
```

## 下一步行动

1. 测试30%/50%阈值
2. 测试绝对阈值0.15
3. 测试反转热图+修复阈值的组合
