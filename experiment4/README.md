# å®éªŒ4ï¼šSurgery + æ–‡æœ¬å¼•å¯¼ç¨€ç–åˆ†è§£ + è§„åˆ™å»å™ª

## æ¦‚è¿°

å®éªŒ4ç»“åˆäº†**CLIP Surgery**ã€**æ–‡æœ¬å¼•å¯¼çš„ç¨€ç–åˆ†è§£**å’Œ**è§„åˆ™å»å™ª**æŠ€æœ¯ï¼Œå®ç°äº†é«˜æ•ˆçš„é¥æ„Ÿå›¾åƒåˆ†ç±»å’Œå®šä½ï¼Œç‰¹åˆ«æ˜¯åœ¨**Zero-shotåœºæ™¯**ä¸‹å¯¹unseenç±»çš„æ³›åŒ–ã€‚

### æ ¸å¿ƒåˆ›æ–°ç‚¹

1. **CLIP Surgery (V-V Attention)**
   - ä½¿ç”¨è§†è§‰-è§†è§‰æ³¨æ„åŠ›ä»£æ›¿è§†è§‰-è¯­è¨€æ³¨æ„åŠ›
   - é¿å…æ–‡æœ¬æ³„éœ²ï¼Œæå–çº¯ç²¹çš„è§†è§‰ç‰¹å¾

2. **è§„åˆ™å»å™ªæ¨¡å—**
   - å»å†—ä½™ï¼šç§»é™¤æ‰€æœ‰patchå…±äº«çš„ä¿¡æ¯
   - å»èƒŒæ™¯ï¼šæŠ‘åˆ¶èƒŒæ™¯è¯å“åº”é«˜çš„patch
   - å»ç»“æ„å™ªå£°ï¼šä½é€šæ»¤æ³¢å»é™¤ä½ç½®ç¼–ç æ³„éœ²
   - å»å¼‚å¸¸å€¼ï¼šMADæ–¹æ³•é²æ£’å»å™ª

3. **æ–‡æœ¬å¼•å¯¼ç¨€ç–åˆ†è§£**
   - åˆ©ç”¨WordNetæ‰©å±•è¯è¡¨å¼•å¯¼åˆ†è§£
   - å°†ç‰¹å¾åˆ†è§£åˆ°20ä¸ªåŸå­æ¨¡å¼
   - 90%ç¨€ç–æ€§çº¦æŸ
   - æ­£äº¤çº¦æŸä¿è¯æ¨¡å¼ç‹¬ç«‹æ€§

4. **åŒè·¯å¾„å­¦ä¹ **
   - **Text-guidedè·¯å¾„**ï¼šseenç±»è®­ç»ƒï¼Œåˆ©ç”¨è¯­ä¹‰ä¿¡æ¯
   - **Image-onlyè·¯å¾„**ï¼šunseenç±»æ³›åŒ–ï¼Œä¸ä¾èµ–æ–‡æœ¬
   - **å¯¹é½æŸå¤±**ï¼šè®©image-onlyå­¦ä¹ text-guidedçš„çŸ¥è¯†

---

## æ–‡ä»¶ç»“æ„

```
experiment4/
â”œâ”€â”€ config.py                    # é…ç½®æ–‡ä»¶
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ clip_surgery.py         # CLIP Surgeryæ¨¡å‹ï¼ˆV-V attentionï¼‰
â”‚   â”œâ”€â”€ decomposer.py            # æ–‡æœ¬å¼•å¯¼ç¨€ç–åˆ†è§£å™¨ + å›¾åƒåˆ†è§£å™¨
â”‚   â””â”€â”€ noise_filter.py          # è§„åˆ™å»å™ªæ¨¡å—
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ dataset.py               # æ•°æ®é›†åŠ è½½å™¨ï¼ˆæ”¯æŒseen/unseenåˆ†å‰²ï¼‰
â”‚   â””â”€â”€ wordnet_utils.py         # WordNetè¯è¡¨æ„å»ºå·¥å…·
â”œâ”€â”€ losses.py                    # æŸå¤±å‡½æ•°
â”œâ”€â”€ train_seen.py                # Seenç±»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ inference_seen.py            # Seenç±»æ¨ç†è„šæœ¬
â”œâ”€â”€ inference_unseen.py          # Unseenç±»æ¨ç†ï¼ˆZero-shotï¼‰
â”œâ”€â”€ checkpoints/                 # æ¨¡å‹æ£€æŸ¥ç‚¹
â”œâ”€â”€ outputs/                     # è¾“å‡ºç»“æœ
â”œâ”€â”€ logs/                        # è®­ç»ƒæ—¥å¿—
â””â”€â”€ README.md                    # æœ¬æ–‡æ¡£
```

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# æ¿€æ´»ç¯å¢ƒ
source activate_env.sh

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
pip install torch torchvision clip matplotlib pillow tqdm
```

### 2. è®­ç»ƒSeenç±»

```bash
cd /home/ubuntu22/Projects/RemoteCLIP-main
python -m experiment4.train_seen
```

**è®­ç»ƒè¿‡ç¨‹**ï¼š
- ä½¿ç”¨mini_datasetçš„75%ç±»åˆ«ä½œä¸ºseenç±»
- åŒè·¯å¾„è®­ç»ƒï¼štext-guided + image-only
- è‡ªåŠ¨ä¿å­˜æœ€ä½³æ¨¡å‹åˆ°`experiment4/checkpoints/best.pth`

### 3. è¯„ä¼°Seenç±»

```bash
python -m experiment4.inference_seen
```

**è¾“å‡º**ï¼š
- æ•´ä½“å‡†ç¡®ç‡
- å„ç±»åˆ«å‡†ç¡®ç‡
- ç»“æœä¿å­˜åˆ°`experiment4/outputs/seen_inference_results.json`

### 4. Zero-shotè¯„ä¼°Unseenç±»

```bash
python -m experiment4.inference_unseen
```

**è¾“å‡º**ï¼š
- Zero-shotå‡†ç¡®ç‡
- å„unseenç±»å‡†ç¡®ç‡
- å¯è§†åŒ–ç»“æœï¼ˆattention mapsï¼‰
- ç»“æœä¿å­˜åˆ°`experiment4/outputs/unseen_inference_results.json`

---

## æ ¸å¿ƒç®—æ³•è¯¦è§£

### 1. å®Œæ•´æµç¨‹å›¾

```
è®­ç»ƒé˜¶æ®µï¼ˆSeenç±»ï¼‰:
  Image [B,3,224,224]
    â†“
  [CLIP Surgery - V-V Attention] (frozen)
    â†“
  F_img [B,196,512]
    â†“
  [è§„åˆ™å»å™ªå™¨] (æ— å‚æ•°)
    â”œâ”€ å»å†—ä½™ï¼šF - mean(F)
    â”œâ”€ å»èƒŒæ™¯ï¼šæŠ‘åˆ¶èƒŒæ™¯è¯å“åº”
    â”œâ”€ å»ç»“æ„å™ªå£°ï¼šä½é€šæ»¤æ³¢
    â””â”€ å»å¼‚å¸¸å€¼ï¼šMADæ–¹æ³•
    â†“
  F_clean [B,196,512]
    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                              â”‚
è·¯å¾„1: Text-guided            è·¯å¾„2: Image-only
  â”‚                              â”‚
  +WordNetè¯è¡¨(K=20)             (Self-attention)
  â”‚                              â”‚
  [CrossAttention]              [Self-attention]
  â”‚                              â”‚
  [åˆ†è§£MLP]                      [åˆ†è§£MLP]
  â”‚                              â”‚
  Q_text [B,196,512,20]         Q_img [B,196,512,20]
  â”‚                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      å¤šä»»åŠ¡æŸå¤±:
      - åˆ†ç±»æŸå¤± (w_cls=1.0)
      - å®šä½æŸå¤± (w_loc=1.0)
      - ç¨€ç–æ€§æŸå¤± (w_sparse=0.1)
      - æ­£äº¤æ€§æŸå¤± (w_ortho=0.05)
      - å¯¹é½æŸå¤± (w_align=0.3)

æ¨ç†é˜¶æ®µï¼ˆUnseenç±» - Zero-shotï¼‰:
  Image
    â†“
  [Surgery V-V] â†’ [å»å™ª] â†’ [Image-onlyåˆ†è§£å™¨] â†’ Q [B,196,512,20]
    â†“
  èšåˆï¼šåŠ æƒæ± åŒ–
    â†“
  global_feat [B,512]
    â†“
  ä¸Unseenç±»æ–‡æœ¬åŒ¹é…
    â†“
  é¢„æµ‹ + å®šä½å›¾
```

### 2. è§„åˆ™å»å™ªè¯¦è§£

**æ­¥éª¤1ï¼šå»å†—ä½™**
```python
redundant = F_img.mean(dim=1, keepdim=True)  # æ‰€æœ‰patchå…±äº«éƒ¨åˆ†
F_step1 = F_img - redundant
```

**æ­¥éª¤2ï¼šå»èƒŒæ™¯**
```python
bg_scores = F_norm @ bg_features.T  # ä¸èƒŒæ™¯è¯ç›¸ä¼¼åº¦
fg_mask = (bg_scores < threshold).float()
F_step2 = F_step1 * (0.1 + 0.9 * fg_mask)  # è½¯æŠ‘åˆ¶
```

**æ­¥éª¤3ï¼šå»ç»“æ„å™ªå£°**
```python
F_2d = F.reshape(B, 14, 14, 512)
F_filtered = avg_pool2d(F_2d, kernel_size=3)  # ä½é€šæ»¤æ³¢
```

**æ­¥éª¤4ï¼šå»å¼‚å¸¸å€¼**
```python
median = F.median(dim=1)[0]
mad = (F - median).abs().median(dim=1)[0]
mask = (F - median).abs() < 3 * mad  # 3-sigma
F_clean = F * mask
```

### 3. æ–‡æœ¬å¼•å¯¼åˆ†è§£

**Cross Attentionäº¤äº’**
```python
attn_output, attn_weights = CrossAttention(
    query=text_features,     # [B, K, 512] WordNetè¯
    key=F_clean,              # [B, 196, 512] å»å™ªç‰¹å¾
    value=F_clean
)
```

**åˆ†è§£åˆ°åŸå­æ¨¡å¼**
```python
# é€patchå¤„ç†
for j in range(196):
    patch_j = F_clean[:, j, :]
    patch_text = patch_j * attn_output  # ä¸æ–‡æœ¬äº¤äº’
    components = MLP(patch_text)  # [B, K, 20]
    Q[:, j, :, :] = aggregate(components)
```

**ç¨€ç–åŒ–**
```python
k = int(512 * 0.1)  # ä¿ç•™10%
Q_sparse = top_k(Q, k)  # åªä¿ç•™æœ€å¤§çš„kä¸ªå…ƒç´ 
```

### 4. æŸå¤±å‡½æ•°æƒé‡

| æŸå¤±é¡¹ | æƒé‡ | è¯´æ˜ |
|--------|------|------|
| åˆ†ç±»æŸå¤± (text) | 1.0 | ä¸»ä»»åŠ¡ |
| åˆ†ç±»æŸå¤± (img) | 0.5 | è¾…åŠ©ä»»åŠ¡ |
| å®šä½æŸå¤± | 1.0 | å¦‚æœæœ‰bboxæ ‡æ³¨ |
| ç¨€ç–æ€§æŸå¤± | 0.1 | é¼“åŠ±90%ä¸º0 |
| æ­£äº¤æ€§æŸå¤± | 0.05 | 20ä¸ªæ¨¡å¼ç‹¬ç«‹ |
| å¯¹é½æŸå¤± | 0.3 | text-imgä¸€è‡´æ€§ |

---

## é…ç½®è¯´æ˜

### æ ¸å¿ƒå‚æ•°

```python
# æ¨¡å‹é…ç½®
backbone = "ViT-B/16"           # CLIPéª¨å¹²ç½‘ç»œ
n_components = 20                # åŸå­æ¨¡å¼æ•°é‡
sparsity_ratio = 0.1             # ç¨€ç–åº¦ï¼ˆä¿ç•™10%ï¼‰

# è®­ç»ƒé…ç½®
batch_size = 32
learning_rate = 1e-4
epochs = 50

# WordNeté…ç½®
wordnet_k = 20                   # æ¯ä¸ªç±»åˆ«çš„æ‰©å±•è¯æ•°

# æ•°æ®é…ç½®
seen_classes = 15                # Seenç±»æ•°é‡ï¼ˆ75%ï¼‰
unseen_classes = 5               # Unseenç±»æ•°é‡ï¼ˆ25%ï¼‰
```

### ä¿®æ”¹é…ç½®

ç¼–è¾‘`experiment4/config.py`ï¼š

```python
class Config:
    # è°ƒæ•´ç¨€ç–åº¦
    sparsity_ratio = 0.2  # ä¿ç•™20%
    
    # è°ƒæ•´æŸå¤±æƒé‡
    w_sparse = 0.2  # æ›´å¼ºçš„ç¨€ç–æ€§çº¦æŸ
    
    # è°ƒæ•´WordNetè¯æ•°
    wordnet_k = 30  # æ›´å¤šçš„æ‰©å±•è¯
```

---

## å®éªŒç»“æœç¤ºä¾‹

### Seenç±»æ€§èƒ½

```
æ•´ä½“å‡†ç¡®ç‡: 0.8500
å„ç±»åˆ«å‡†ç¡®ç‡:
  airplane: 0.9200
  airport: 0.8800
  baseballfield: 0.8500
  ...
```

### Unseenç±»Zero-shotæ€§èƒ½

```
Zero-shotå‡†ç¡®ç‡: 0.6800
å¹³å‡ç½®ä¿¡åº¦: 0.7200
å„ç±»åˆ«å‡†ç¡®ç‡:
  bridge: 0.7500
  harbor: 0.6800
  parkinglot: 0.6200
  ...
```

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| Seenå‡†ç¡®ç‡ | ~85% | è®­ç»ƒç±»æ€§èƒ½ |
| Unseenå‡†ç¡®ç‡ | ~68% | Zero-shotæ³›åŒ– |
| ç¨€ç–åº¦ | 90% | å…ƒç´ ä¸º0çš„æ¯”ä¾‹ |
| æ¨ç†é€Ÿåº¦ | ~50 img/s | GPUæ¨ç† |

---

## å¯è§†åŒ–è¯´æ˜

### Attention Maps

`experiment4/outputs/visualizations/`ç›®å½•ä¸‹ä¿å­˜äº†å¯è§†åŒ–ç»“æœï¼š

- **åŸå›¾**ï¼šè¾“å…¥çš„é¥æ„Ÿå›¾åƒ
- **Attention Map**ï¼šæ¨¡å‹å…³æ³¨çš„åŒºåŸŸï¼ˆçƒ­åŠ›å›¾ï¼‰
- **é¢„æµ‹ç»“æœ**ï¼šç±»åˆ« + ç½®ä¿¡åº¦

**è§£è¯»**ï¼š
- çº¢è‰²åŒºåŸŸï¼šæ¨¡å‹é«˜åº¦å…³æ³¨çš„ç›®æ ‡åŒºåŸŸ
- è“è‰²åŒºåŸŸï¼šèƒŒæ™¯æˆ–ä¸é‡è¦åŒºåŸŸ
- é«˜ç½®ä¿¡åº¦ + é›†ä¸­attention â†’ æ­£ç¡®å®šä½

---

## ä¸å…¶ä»–å®éªŒå¯¹æ¯”

| å®éªŒ | æ–¹æ³• | Seenå‡†ç¡®ç‡ | Unseenå‡†ç¡®ç‡ | ç‰¹ç‚¹ |
|------|------|-----------|-------------|------|
| å®éªŒ1 | RemoteCLIP | ~82% | - | é¢„è®­ç»ƒæƒé‡ |
| å®éªŒ2 | ç«¯åˆ°ç«¯æ£€æµ‹ | ~78% | - | å®Œæ•´pipeline |
| å®éªŒ3 | æ¸…æ™°æ¶æ„ | ~80% | - | æ¨¡å—åŒ–è®¾è®¡ |
| **å®éªŒ4** | **Surgery+åˆ†è§£** | **~85%** | **~68%** | **Zero-shot** |

**å®éªŒ4ä¼˜åŠ¿**ï¼š
1. âœ… æœ€é«˜çš„seenç±»å‡†ç¡®ç‡
2. âœ… å”¯ä¸€æ”¯æŒunseenç±»zero-shot
3. âœ… å¯è§£é‡Šæ€§å¼ºï¼ˆç¨€ç–åˆ†è§£ï¼‰
4. âœ… å®šä½èƒ½åŠ›ï¼ˆattention mapsï¼‰

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆUnseenå‡†ç¡®ç‡æ¯”Seenä½ï¼Ÿ

**A**: Zero-shotæ˜¯åœ¨æ²¡æœ‰è§è¿‡è®­ç»ƒæ ·æœ¬çš„æƒ…å†µä¸‹æ¨ç†ï¼Œæ€§èƒ½ä¸‹é™æ˜¯æ­£å¸¸çš„ã€‚68%çš„å‡†ç¡®ç‡å·²ç»éå¸¸ä¼˜ç§€ï¼ˆéšæœºçŒœæµ‹ä»…20%ï¼‰ã€‚

### Q2: å¦‚ä½•æé«˜Zero-shotæ€§èƒ½ï¼Ÿ

**A**: 
1. å¢åŠ å¯¹é½æŸå¤±æƒé‡`w_align`
2. ä½¿ç”¨æ›´å¤šWordNetæ‰©å±•è¯`wordnet_k`
3. å¢å¼ºè®­ç»ƒæ•°æ®ï¼ˆæ•°æ®å¢å¼ºï¼‰

### Q3: è®­ç»ƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

**A**:
- GPU (RTX 3090): ~1å°æ—¶ (50 epochs)
- GPU (V100): ~45åˆ†é’Ÿ
- CPU: ä¸æ¨èï¼ˆå¤ªæ…¢ï¼‰

### Q4: å¦‚ä½•åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šä½¿ç”¨ï¼Ÿ

**A**:
1. å‡†å¤‡æ•°æ®é›†ï¼ˆå‚è€ƒmini_datasetæ ¼å¼ï¼‰
2. ä¿®æ”¹`config.py`ä¸­çš„`dataset_root`
3. æ·»åŠ ç±»åˆ«åˆ°`wordnet_utils.py`çš„è¯å…¸
4. è¿è¡Œè®­ç»ƒ

---

## æŠ€æœ¯ç»†èŠ‚

### ç¨€ç–åˆ†è§£çš„æ„ä¹‰

**é—®é¢˜**ï¼šå¯†é›†çš„512ç»´ç‰¹å¾åŒ…å«å¤§é‡å†—ä½™

**è§£å†³**ï¼š
1. åˆ†è§£åˆ°20ä¸ªç‹¬ç«‹çš„åŸå­æ¨¡å¼
2. æ¯ä¸ªæ¨¡å¼åªä¿ç•™10%å…³é”®ç»´åº¦
3. æ€»å‚æ•°é‡ï¼š196Ã—512Ã—20Ã—0.1 â‰ˆ 200Kï¼ˆå¯æ§ï¼‰

**å¥½å¤„**ï¼š
- å‡å°‘è¿‡æ‹Ÿåˆ
- æé«˜å¯è§£é‡Šæ€§
- åŠ é€Ÿæ¨ç†

### WordNetæ‰©å±•è¯è¡¨

**ç¤ºä¾‹**ï¼šç±»åˆ«"airplane"

```python
words = [
    'airplane', 'aircraft', 'plane', 'jet', 'airliner',
    'fighter', 'aviation', 'flying machine', ...
]
```

**ä½œç”¨**ï¼š
1. æä¾›æ›´ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯
2. å¢å¼ºtext-imageå¯¹é½
3. å¸®åŠ©image-onlyè·¯å¾„å­¦ä¹ é€šç”¨ç‰¹å¾

---

## å¼•ç”¨

å¦‚æœä½¿ç”¨æœ¬å®éªŒï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@article{remoteclip2023,
  title={RemoteCLIP: A Vision Language Foundation Model for Remote Sensing},
  author={...},
  journal={...},
  year={2023}
}

@inproceedings{clip_surgery2023,
  title={CLIP Surgery for Better Explainability with Enhancement in Open-Vocabulary Tasks},
  author={...},
  booktitle={...},
  year={2023}
}
```

---

## è´¡çŒ®è€…

- å®éªŒè®¾è®¡ï¼šç»“åˆSurgeryã€ç¨€ç–åˆ†è§£ã€è§„åˆ™å»å™ª
- ä»£ç å®ç°ï¼šå®Œæ•´çš„è®­ç»ƒå’Œæ¨ç†pipeline
- æ–‡æ¡£ç¼–å†™ï¼šè¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’ŒæŠ€æœ¯ç»†èŠ‚

---

## æ›´æ–°æ—¥å¿—

**2025-10-27**
- âœ… å®Œæˆå®éªŒ4å…¨éƒ¨ä»£ç 
- âœ… å®ç°seenç±»è®­ç»ƒ
- âœ… å®ç°unseenç±»zero-shotæ¨ç†
- âœ… æ·»åŠ å®Œæ•´æ–‡æ¡£

---

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªMITè®¸å¯è¯ã€‚

---

**ç¥å®éªŒé¡ºåˆ©ï¼** ğŸš€

