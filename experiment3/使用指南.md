# Experiment3 ä½¿ç”¨æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥ç¯å¢ƒ

```bash
cd /home/ubuntu22/Projects/RemoteCLIP-main/experiment3
bash quick_start.sh
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- âœ… DIORæ•°æ®é›†æ˜¯å¦å­˜åœ¨
- âœ… RemoteCLIPæƒé‡æ˜¯å¦å­˜åœ¨
- âœ… æ ¸å¿ƒæ¨¡å—æ˜¯å¦å¯ç”¨

### 2. è¿è¡Œæ¼”ç¤º

```bash
python demo.py
```

è¿™ä¼šå±•ç¤ºï¼š
- æ¨¡å‹åˆ›å»ºè¿‡ç¨‹
- å‰å‘ä¼ æ’­ç¤ºä¾‹
- è®­ç»ƒæµç¨‹è¯´æ˜
- æ¨ç†ç¤ºä¾‹
- è¯„ä¼°æµç¨‹
- æ•°æ®é›†ä¿¡æ¯
- å®Œæ•´æ¶æ„å›¾

### 3. å¼€å§‹è®­ç»ƒ

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆå°æ‰¹æ¬¡ï¼Œå°‘è½®æ•°ï¼‰
python train.py \
  --data_dir ../datasets/DIOR \
  --output_dir ./outputs \
  --batch_size 2 \
  --epochs 5

# å®Œæ•´è®­ç»ƒ
python train.py \
  --data_dir ../datasets/DIOR \
  --output_dir ./outputs \
  --batch_size 8 \
  --epochs 50 \
  --lr 1e-4 \
  --num_workers 8
```

### 4. æŸ¥çœ‹è®­ç»ƒæ—¥å¿—

```bash
tensorboard --logdir outputs/logs --port 6006
```

ç„¶ååœ¨æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:6006`

### 5. æ¨ç†æµ‹è¯•

```bash
# å•å¼ å›¾åƒ
python inference/inference_engine.py \
  --checkpoint outputs/checkpoints/best.pth \
  --image ../datasets/DIOR/images/trainval/00001.jpg \
  --output result.jpg

# æŸ¥çœ‹ç»“æœ
eog result.jpg
```

### 6. æ¨¡å‹è¯„ä¼°

```bash
python evaluate.py \
  --checkpoint outputs/checkpoints/best.pth \
  --data_dir ../datasets/DIOR \
  --output evaluation_results.json

# æŸ¥çœ‹ç»“æœ
cat evaluation_results.json | python -m json.tool
```

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
experiment3/
â”œâ”€â”€ ğŸ“ backbone/              RemoteCLIPéª¨å¹²ç½‘ç»œ
â”œâ”€â”€ ğŸ“ encoder/               ç¼–ç å™¨ï¼ˆFPN + Transformerï¼‰
â”œâ”€â”€ ğŸ“ decoder/               è§£ç å™¨ï¼ˆTransformerï¼‰
â”œâ”€â”€ ğŸ“ head/                  æ£€æµ‹å¤´ï¼ˆåˆ†ç±» + å›å½’ï¼‰
â”œâ”€â”€ ğŸ“ losses/                æŸå¤±å‡½æ•°
â”œâ”€â”€ ğŸ“ models/                å®Œæ•´æ¨¡å‹
â”œâ”€â”€ ğŸ“ utils/                 å·¥å…·å‡½æ•°
â”œâ”€â”€ ğŸ“ inference/             æ¨ç†å¼•æ“
â”œâ”€â”€ ğŸ“ config/                é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“„ train.py              è®­ç»ƒè„šæœ¬
â”œâ”€â”€ ğŸ“„ evaluate.py           è¯„ä¼°è„šæœ¬
â”œâ”€â”€ ğŸ“„ demo.py               æ¼”ç¤ºè„šæœ¬
â””â”€â”€ ğŸ“„ quick_start.sh        å¿«é€Ÿå¯åŠ¨
```

---

## âš™ï¸ é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ä½äºï¼š`config/default_config.py`

### æ¨¡å‹é…ç½®

```python
# åŸºç¡€é…ç½®
num_queries = 300              # æŸ¥è¯¢æ•°é‡
num_decoder_layers = 6         # è§£ç å™¨å±‚æ•°
d_model = 256                  # æ¨¡å‹ç»´åº¦
num_heads = 8                  # æ³¨æ„åŠ›å¤´æ•°

# RemoteCLIPé…ç½®
remoteclip_model = 'RN50'      # å¯é€‰: RN50, ViT-B-32, ViT-L-14
freeze_remoteclip = True       # æ˜¯å¦å†»ç»“éª¨å¹²ç½‘ç»œ
```

### æŸå¤±æƒé‡

```python
loss_cls_weight = 1.0          # åˆ†ç±»æŸå¤±æƒé‡
loss_bbox_weight = 5.0         # L1æŸå¤±æƒé‡
loss_giou_weight = 2.0         # GIoUæŸå¤±æƒé‡
```

### è®­ç»ƒé…ç½®

```python
batch_size = 8                 # æ‰¹æ¬¡å¤§å°
num_epochs = 50                # è®­ç»ƒè½®æ•°
learning_rate = 1e-4           # å­¦ä¹ ç‡
weight_decay = 1e-4            # æƒé‡è¡°å‡
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å¿«é€Ÿæµ‹è¯•

```bash
# æœ€å°é…ç½®ï¼Œå¿«é€ŸéªŒè¯æµç¨‹
python train.py \
  --data_dir ../datasets/DIOR \
  --output_dir ./test_outputs \
  --batch_size 1 \
  --epochs 1 \
  --num_workers 0
```

### åœºæ™¯2: å®Œæ•´è®­ç»ƒ

```bash
# æ¨èé…ç½®
python train.py \
  --data_dir ../datasets/DIOR \
  --output_dir ./outputs \
  --batch_size 8 \
  --epochs 50 \
  --lr 1e-4 \
  --num_workers 8
```

### åœºæ™¯3: å¤§æ‰¹æ¬¡è®­ç»ƒ

```bash
# å¦‚æœGPUå†…å­˜å……è¶³ï¼ˆ>16GBï¼‰
python train.py \
  --data_dir ../datasets/DIOR \
  --output_dir ./outputs \
  --batch_size 16 \
  --epochs 50
```

### åœºæ™¯4: ç»§ç»­è®­ç»ƒ

```python
# åœ¨train.pyä¸­æ·»åŠ ï¼š
checkpoint = torch.load('outputs/checkpoints/latest.pth')
model.load_state_dict(checkpoint['model_state_dict'])
optimizer.load_state_dict(checkpoint['optimizer_state_dict'])
start_epoch = checkpoint['epoch'] + 1
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æµ‹è¯•å•ä¸ªæ¨¡å—

```bash
# æµ‹è¯•FPN
cd encoder
python fpn.py

# æµ‹è¯•è§£ç å™¨
cd decoder
python transformer_decoder.py

# æµ‹è¯•æŸå¤±å‡½æ•°
cd losses
python varifocal_loss.py
```

### 2. æŸ¥çœ‹æ¨¡å‹ç»“æ„

```python
from models.ova_detr import OVADETR
from config.default_config import DefaultConfig

config = DefaultConfig()
model = OVADETR(config)

# æ‰“å°æ¨¡å‹
print(model)

# ç»Ÿè®¡å‚æ•°
total = sum(p.numel() for p in model.parameters())
print(f"æ€»å‚æ•°: {total:,}")
```

### 3. å¯è§†åŒ–ç‰¹å¾

```python
# åœ¨å‰å‘ä¼ æ’­ä¸­æ·»åŠ ï¼š
import matplotlib.pyplot as plt

# å¯è§†åŒ–FPNç‰¹å¾
for i, feat in enumerate(fpn_features):
    plt.figure()
    plt.imshow(feat[0, 0].cpu().detach())
    plt.title(f'FPN Layer {i}')
    plt.savefig(f'fpn_layer_{i}.png')
```

### 4. è°ƒè¯•æ•°æ®åŠ è½½

```python
from utils.data_loader import create_data_loader
from utils.transforms import get_transforms

transforms = get_transforms('train')
loader = create_data_loader(
    root_dir='../datasets/DIOR',
    split='train',
    batch_size=1,
    transforms=transforms
)

# æŸ¥çœ‹ä¸€ä¸ªæ‰¹æ¬¡
images, targets = next(iter(loader))
print(f"å›¾åƒ: {images.shape}")
print(f"ç›®æ ‡æ•°é‡: {[len(t['labels']) for t in targets]}")
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. åŠ é€Ÿè®­ç»ƒ

```bash
# å¢åŠ å·¥ä½œè¿›ç¨‹
--num_workers 8

# ä½¿ç”¨æ›´å¤§æ‰¹æ¬¡ï¼ˆå¦‚æœGPUå†…å­˜å…è®¸ï¼‰
--batch_size 16

# ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰
# åœ¨train.pyä¸­æ·»åŠ torch.cuda.amp
```

### 2. å‡å°‘å†…å­˜ä½¿ç”¨

```bash
# å‡å°æ‰¹æ¬¡å¤§å°
--batch_size 4

# å‡å°å›¾åƒå°ºå¯¸ï¼ˆåœ¨configä¸­ä¿®æ”¹ï¼‰
config.image_size = (600, 600)

# å‡å°‘æŸ¥è¯¢æ•°é‡
config.num_queries = 100
```

### 3. æå‡mAP

```python
# è°ƒæ•´æŸå¤±æƒé‡
config.loss_cls_weight = 2.0
config.loss_bbox_weight = 5.0
config.loss_giou_weight = 2.0

# å¢åŠ è®­ç»ƒè½®æ•°
--epochs 100

# è°ƒæ•´å­¦ä¹ ç‡
--lr 5e-5
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: CUDAå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ¡ˆ1: å‡å°æ‰¹æ¬¡
--batch_size 2

# æ–¹æ¡ˆ2: å‡å°å›¾åƒå°ºå¯¸
# åœ¨config.pyä¸­ä¿®æ”¹
config.image_size = (600, 600)

# æ–¹æ¡ˆ3: å‡å°‘æŸ¥è¯¢æ•°
config.num_queries = 100
```

### Q2: è®­ç»ƒå¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ æ•°æ®åŠ è½½å·¥ä½œè¿›ç¨‹
--num_workers 8

# ä½¿ç”¨æ›´å¥½çš„GPU
# ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
```

### Q3: mAPå¾ˆä½

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ•°æ®é›†æ˜¯å¦æ­£ç¡®åŠ è½½ï¼Ÿ
- [ ] æ–‡æœ¬ç‰¹å¾æ˜¯å¦æ­£ç¡®æå–ï¼Ÿ
- [ ] æŸå¤±æ˜¯å¦æ­£å¸¸ä¸‹é™ï¼Ÿ
- [ ] å­¦ä¹ ç‡æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] è®­ç»ƒè½®æ•°æ˜¯å¦è¶³å¤Ÿï¼Ÿ

### Q4: æ¨ç†ç»“æœä¸å¥½

**è°ƒè¯•æ­¥éª¤**ï¼š
```python
# 1. é™ä½åˆ†æ•°é˜ˆå€¼
--score_threshold 0.3

# 2. è°ƒæ•´NMSé˜ˆå€¼
--nms_threshold 0.7

# 3. æ£€æŸ¥æ¨¡å‹è¾“å‡º
outputs = model(images, text_features)
print(f"æœ€å¤§åˆ†æ•°: {outputs['pred_logits'].max()}")
print(f"æœ€å°åˆ†æ•°: {outputs['pred_logits'].min()}")
```

---

## ğŸ“ˆ é¢„æœŸç»“æœ

### è®­ç»ƒè¿‡ç¨‹

```
Epoch 1/50
  loss: 15.2341, cls: 8.1234, bbox: 4.5678, giou: 2.5429
  
Epoch 10/50
  loss: 8.3421, cls: 4.2345, bbox: 2.8765, giou: 1.2311

Epoch 50/50
  loss: 3.2156, cls: 1.5678, bbox: 1.2345, giou: 0.4133
```

### è¯„ä¼°ç»“æœ

```
mAP@0.5: 0.65 (é¢„æœŸ)

å„ç±»åˆ«AP:
  airplane: 0.78
  ship: 0.72
  harbor: 0.68
  ...
```

### æ¨ç†é€Ÿåº¦

```
GPU (RTX 3090): ~10 FPS
GPU (RTX 4090): ~15 FPS
CPU: ~0.5 FPS
```

---

## ğŸ“ è¿›é˜¶ä½¿ç”¨

### è‡ªå®šä¹‰ç±»åˆ«

```python
# ä¿®æ”¹utils/data_loader.py
CUSTOM_CLASSES = ['my_class1', 'my_class2', ...]

# æå–è‡ªå®šä¹‰æ–‡æœ¬ç‰¹å¾
text_features = model.backbone.forward_text(CUSTOM_CLASSES)
```

### ä¿®æ”¹ç½‘ç»œç»“æ„

```python
# åœ¨models/ova_detr.pyä¸­ä¿®æ”¹
self.decoder = TransformerDecoder(
    num_layers=12,  # å¢åŠ å±‚æ•°
    d_model=512,    # å¢åŠ ç»´åº¦
    ...
)
```

### æ·»åŠ æ•°æ®å¢å¼º

```python
# åœ¨utils/transforms.pyä¸­æ·»åŠ 
class MyTransform:
    def __call__(self, image, target):
        # è‡ªå®šä¹‰å¢å¼º
        return image, target
```

---

## ğŸ“ è·å–å¸®åŠ©

1. **æŸ¥çœ‹æ–‡æ¡£**
   - README.md
   - é¡¹ç›®å®Œæˆæ€»ç»“.md
   - æœ¬æ–‡æ¡£

2. **è¿è¡Œæ¼”ç¤º**
   ```bash
   python demo.py
   ```

3. **æµ‹è¯•æ¨¡å—**
   ```bash
   python encoder/fpn.py
   python decoder/transformer_decoder.py
   ```

4. **æŸ¥çœ‹ç¤ºä¾‹**
   - æ¯ä¸ªæ¨¡å—éƒ½æœ‰ `if __name__ == "__main__"` æµ‹è¯•ä»£ç 
   - å¯ä»¥ç›´æ¥è¿è¡ŒæŸ¥çœ‹æ•ˆæœ

---

## âœ… æ£€æŸ¥æ¸…å•

å¼€å§‹è®­ç»ƒå‰æ£€æŸ¥ï¼š

- [ ] DIORæ•°æ®é›†å·²å‡†å¤‡
- [ ] RemoteCLIPæƒé‡å·²ä¸‹è½½
- [ ] Pythonç¯å¢ƒå·²é…ç½®
- [ ] GPUé©±åŠ¨å·²å®‰è£…
- [ ] å·²è¿è¡Œquick_start.sh
- [ ] å·²è¿è¡Œdemo.py

è®­ç»ƒä¸­æ£€æŸ¥ï¼š

- [ ] æŸå¤±æ­£å¸¸ä¸‹é™
- [ ] GPUåˆ©ç”¨ç‡æ­£å¸¸
- [ ] æ— CUDAå†…å­˜é”™è¯¯
- [ ] æ£€æŸ¥ç‚¹æ­£å¸¸ä¿å­˜

è®­ç»ƒåæ£€æŸ¥ï¼š

- [ ] æœ€ä½³æ¨¡å‹å·²ä¿å­˜
- [ ] mAPå·²è®¡ç®—
- [ ] æ¨ç†ç»“æœæ­£å¸¸
- [ ] å¯è§†åŒ–ç»“æœåˆç†

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

